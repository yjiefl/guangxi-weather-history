# 数据管理功能使用说明

## 功能概述

系统新增了三个强大的数据管理功能：

### 1. 批量下载数据 📥

**功能**: 从Open-Meteo API下载指定时间段的数据并自动保存到本地数据库

**使用步骤**:

1. 在"数据管理"面板中选择"批量下载"标签
2. 选择城市（如：南宁）
3. 选择日期范围（建议从2024-01-01开始测试）
4. 点击"下载并保存到数据库"按钮
5. 系统会自动从API获取数据并保存到SQLite数据库

**优势**:

- 一次性下载大量数据，避免重复API调用
- 数据永久保存在本地，查询速度快
- 支持断点续传（重复下载会自动更新）

### 2. 数据完整性检查 ✅

**功能**: 检查数据库中已有哪些日期的数据，缺少哪些日期的数据

**使用步骤**:

1. 选择"完整性检查"标签
2. 选择城市和日期范围
3. 点击"检查数据完整性"按钮
4. 系统会显示：
   - 完整性百分比
   - 总天数、已有天数、缺失天数
   - 具体缺失的日期范围

**应用场景**:

- 在批量下载前，先检查哪些数据已存在
- 定期检查数据完整性，确保数据连续
- 找出缺失的日期范围，针对性补充数据

### 3. 数据统计 📊

**功能**: 查看所有城市的数据存储情况

**显示信息**:

- 每个城市的记录数量
- 最早数据日期
- 最新数据日期
- 总体统计（总城市数、总记录数）

**使用场景**:

- 快速了解数据库存储状态
- 识别哪些城市需要补充数据
- 监控数据增长情况

## 典型使用流程

### 场景1: 首次使用，下载历史数据

```text
1. 打开"数据管理" → "批量下载"
2. 选择"南宁"
3. 日期范围: 2024-01-01 至 2024-12-31
4. 点击"下载并保存到数据库"
5. 等待下载完成（约1-2分钟，取决于网络速度）
6. 查看"数据统计"确认数据已保存
```

### 场景2: 检查数据完整性并补充缺失数据

```text
1. 打开"数据管理" → "完整性检查"
2. 选择城市和日期范围
3. 点击"检查数据完整性"
4. 查看缺失的日期范围
5. 切换到"批量下载"标签
6. 针对缺失的日期范围进行下载
```

### 场景3: 定期自动更新（未来功能）

```text
目前支持手动更新，未来可以：
- 设置定时任务
- 每天自动下载最新5天的数据
- 自动填补缺失的历史数据
```

## API端点说明

### 批量下载

```http
POST /api/data/batch-download
{
  "city_id": 1,
  "start_date": "2024-01-01",
  "end_date": "2024-01-31",
  "fields": ["temperature_2m", "wind_speed_10m", "shortwave_radiation"]
}
```

### 完整性检查

```http
POST /api/data/check-completeness
{
  "city_id": 1,
  "start_date": "2024-01-01",
  "end_date": "2024-12-31"
}
```

### 数据统计

```http
GET /api/data/statistics
```

### 自动更新（最近7天）

```http
POST /api/data/auto-update
{
  "city_id": 1,
  "days_back": 7,
  "fields": ["temperature_2m", "wind_speed_10m"]
}
```

### 批量下载所有城市

```http
POST /api/data/batch-download-all
{
  "start_date": "2024-01-01",
  "end_date": "2024-01-31",
  "fields": ["temperature_2m", "wind_speed_10m"]
}
```

## 注意事项

1. **Open-Meteo数据延迟**: 历史数据有5天延迟，最新可获取的是5天前的数据
2. **日期范围**: 建议单次下载不超过1年的数据，避免超时
3. **网络要求**: 需要稳定的互联网连接
4. **存储空间**: 每个城市每年约8760条记录（每小时1条），请确保有足够存储空间
5. **重复下载**: 系统会自动处理重复数据（使用REPLACE策略）

## 数据库位置

数据保存在: `data/weather.db`

可以使用SQLite工具直接查看和管理数据。

## 性能优化建议

1. **先下载后查询**: 对于经常查询的时间段，先批量下载到数据库
2. **定期检查**: 每周检查一次数据完整性
3. **分批下载**: 大时间范围分成多个小批次下载
4. **缓存利用**: API响应会自动缓存30天

## 故障排除

**问题**: 下载失败

- 检查网络连接
- 确认日期格式正确（YYYY-MM-DD）
- 查看logs/debug.log了解详细错误

**问题**: 完整性检查显示缺失很多数据

- 正常现象，需要手动批量下载
- 使用批量下载功能补充数据

**问题**: 数据统计显示记录数为0

- 表示该城市还没有下载任何数据
- 使用批量下载功能开始下载
